name: Code Quality

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-analyze:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore BruteGamingMacros.sln

    - name: Build solution (Debug)
      run: msbuild BruteGamingMacros.sln /p:Configuration=Debug /p:Platform="Any CPU" /m /nologo

    - name: Build solution (Release)
      run: msbuild BruteGamingMacros.sln /p:Configuration=Release /p:Platform="Any CPU" /m /nologo

    - name: Check for compiler warnings
      shell: powershell
      run: |
        Write-Host "Checking for compiler warnings..." -ForegroundColor Yellow
        $buildLog = msbuild BruteGamingMacros.sln /p:Configuration=Release /p:Platform="Any CPU" /v:detailed 2>&1

        $warnings = $buildLog | Select-String -Pattern "warning CS"

        if ($warnings) {
          Write-Host "Compiler warnings found:" -ForegroundColor Red
          $warnings | ForEach-Object { Write-Host $_.Line -ForegroundColor Yellow }
          Write-Host ""
          Write-Host "Total warnings: $($warnings.Count)" -ForegroundColor Red

          if ($warnings.Count -gt 0) {
            Write-Warning "Build has $($warnings.Count) warnings. Please fix them."
            # Don't fail the build for warnings in initial setup
            # exit 1
          }
        } else {
          Write-Host "✓ No compiler warnings found" -ForegroundColor Green
        }

    - name: Code analysis summary
      shell: powershell
      run: |
        Write-Host "======================================" -ForegroundColor Cyan
        Write-Host "Code Quality Summary" -ForegroundColor Cyan
        Write-Host "======================================" -ForegroundColor Cyan
        Write-Host ""

        # Count source files
        $csFiles = (Get-ChildItem -Path . -Filter "*.cs" -Recurse -File | Where-Object { $_.FullName -notmatch "\\obj\\|\\bin\\|AssemblyInfo" }).Count
        Write-Host "C# source files: $csFiles" -ForegroundColor White

        # Count lines of code (approximate)
        $loc = 0
        Get-ChildItem -Path . -Filter "*.cs" -Recurse -File | Where-Object { $_.FullName -notmatch "\\obj\\|\\bin\\|AssemblyInfo" } | ForEach-Object {
          $loc += (Get-Content $_.FullName | Measure-Object -Line).Lines
        }
        Write-Host "Lines of code (approx): $loc" -ForegroundColor White

        Write-Host ""
        Write-Host "Build configurations tested:" -ForegroundColor Yellow
        Write-Host "  ✓ Debug" -ForegroundColor Green
        Write-Host "  ✓ Release" -ForegroundColor Green
        Write-Host ""
        Write-Host "✓ Code quality check completed" -ForegroundColor Green

  security-scan:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for sensitive data
      shell: powershell
      run: |
        Write-Host "Scanning for sensitive data..." -ForegroundColor Yellow

        $patterns = @{
          "API Keys" = "(?i)(api[_-]?key|apikey)[\s]*[=:][\s]*['""`"]?[\w\-]{20,}['""`"]?"
          "Passwords" = "(?i)(password|passwd|pwd)[\s]*[=:][\s]*['""`"][^'""`"]{1,}['""`"]"
          "Private Keys" = "-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----"
          "AWS Keys" = "(?i)aws[_-]?(access[_-]?key[_-]?id|secret[_-]?access[_-]?key)"
          "GitHub Tokens" = "ghp_[a-zA-Z0-9]{36}"
          "Connection Strings" = "(?i)(server|data source|initial catalog|user id|password)=[^;]+;.*password=[^;]+"
        }

        $findings = @()

        foreach ($patternName in $patterns.Keys) {
          $pattern = $patterns[$patternName]
          $matches = Get-ChildItem -Path . -Include "*.cs","*.config","*.xml","*.json" -Recurse -File |
            Where-Object { $_.FullName -notmatch "\\obj\\|\\bin\\" } |
            Select-String -Pattern $pattern

          if ($matches) {
            foreach ($match in $matches) {
              $findings += @{
                Type = $patternName
                File = $match.Path
                Line = $match.LineNumber
                Text = $match.Line.Trim()
              }
            }
          }
        }

        if ($findings.Count -gt 0) {
          Write-Host "⚠ Potential sensitive data found:" -ForegroundColor Red
          foreach ($finding in $findings) {
            Write-Host "  [$($finding.Type)] $($finding.File):$($finding.Line)" -ForegroundColor Yellow
            Write-Host "    $($finding.Text)" -ForegroundColor Gray
          }
          Write-Host ""
          Write-Warning "Found $($findings.Count) potential sensitive data patterns. Please review."
          # Don't fail - these may be false positives
        } else {
          Write-Host "✓ No obvious sensitive data patterns found" -ForegroundColor Green
        }

    - name: Check dependencies for known vulnerabilities
      shell: powershell
      run: |
        Write-Host "Checking dependencies..." -ForegroundColor Yellow

        if (Test-Path "packages.config") {
          [xml]$packages = Get-Content "packages.config"

          Write-Host "Installed packages:" -ForegroundColor White
          foreach ($package in $packages.packages.package) {
            Write-Host "  - $($package.id) v$($package.version)" -ForegroundColor Gray
          }

          # Check for known vulnerable packages (add more as needed)
          $knownVulnerable = @{
            "System.Net.Http" = @("4.3.0", "4.3.1", "4.3.2", "4.3.3", "4.3.4")
            "Newtonsoft.Json" = @("12.0.0", "12.0.1", "12.0.2", "12.0.3")
          }

          $vulnerabilities = @()

          foreach ($package in $packages.packages.package) {
            $packageId = $package.id
            $packageVersion = $package.version

            if ($knownVulnerable.ContainsKey($packageId)) {
              if ($knownVulnerable[$packageId] -contains $packageVersion) {
                $vulnerabilities += "$packageId v$packageVersion"
              }
            }
          }

          if ($vulnerabilities.Count -gt 0) {
            Write-Host ""
            Write-Host "⚠ Potentially vulnerable packages found:" -ForegroundColor Red
            foreach ($vuln in $vulnerabilities) {
              Write-Host "  - $vuln" -ForegroundColor Yellow
            }
            Write-Warning "Please update vulnerable packages"
          } else {
            Write-Host ""
            Write-Host "✓ No known vulnerable packages detected" -ForegroundColor Green
          }
        }

    - name: Security scan summary
      shell: powershell
      run: |
        Write-Host ""
        Write-Host "======================================" -ForegroundColor Cyan
        Write-Host "Security Scan Summary" -ForegroundColor Cyan
        Write-Host "======================================" -ForegroundColor Cyan
        Write-Host "✓ Sensitive data scan completed" -ForegroundColor Green
        Write-Host "✓ Dependency vulnerability check completed" -ForegroundColor Green
        Write-Host ""
        Write-Host "Note: This is a basic security scan. For comprehensive" -ForegroundColor Gray
        Write-Host "security analysis, use dedicated tools like:" -ForegroundColor Gray
        Write-Host "  - SonarQube" -ForegroundColor Gray
        Write-Host "  - OWASP Dependency-Check" -ForegroundColor Gray
        Write-Host "  - Snyk" -ForegroundColor Gray
