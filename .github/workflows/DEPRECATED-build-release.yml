# ⚠️ DEPRECATED - DO NOT USE
# This workflow has been replaced by release-consolidated.yml
# Kept for historical reference only
# Will be deleted after 2025-12-01

name: "[DEPRECATED] Build and Release"

on:
  # Triggers disabled - workflow inactive
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Extract version from tag
      id: version
      shell: powershell
      run: |
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
        } else {
          $version = "${{ github.event.inputs.version }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Update version in files
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        Set-Content -Path "build\version.txt" -Value $version
        echo "Version set to: $version"

    - name: Restore NuGet packages
      run: nuget restore BruteGamingMacros.sln

    - name: Build solution (Release)
      run: msbuild BruteGamingMacros.sln /p:Configuration=Release /p:Platform="Any CPU" /m /nologo /v:minimal

    - name: Build solution (ReleaseMR)
      continue-on-error: true
      run: msbuild BruteGamingMacros.sln /p:Configuration=ReleaseMR /p:Platform="Any CPU" /m /nologo /v:minimal

    - name: Build solution (ReleaseHR)
      continue-on-error: true
      run: msbuild BruteGamingMacros.sln /p:Configuration=ReleaseHR /p:Platform="Any CPU" /m /nologo /v:minimal

    - name: Build solution (ReleaseLR)
      continue-on-error: true
      run: msbuild BruteGamingMacros.sln /p:Configuration=ReleaseLR /p:Platform="Any CPU" /m /nologo /v:minimal

    - name: Install NSIS
      shell: powershell
      run: |
        Write-Host "Installing NSIS via Chocolatey..."
        choco install nsis -y
        Write-Host "NSIS installed"
        & "C:\Program Files (x86)\NSIS\makensis.exe" /VERSION

    - name: Build NSIS installer
      shell: powershell
      run: |
        if (Test-Path "installer\installer.nsi") {
          Write-Host "Building NSIS installer..."
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DVERSION="${{ steps.version.outputs.VERSION }}" installer\installer.nsi
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Installer built successfully"
          } else {
            Write-Warning "NSIS build returned exit code: $LASTEXITCODE"
          }
        } else {
          Write-Warning "NSIS installer script not found at installer\installer.nsi"
        }

    - name: Create portable packages
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"

        # Function to create portable package
        function Create-PortablePackage {
          param($config, $suffix)

          $binPath = "bin\$config"
          if (-not (Test-Path $binPath)) {
            Write-Warning "$config build not found, skipping"
            return
          }

          $zipName = "BruteGamingMacros-v$version$suffix-portable.zip"
          $tempDir = "temp_$config"

          # Create temp directory
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

          # Copy files
          Copy-Item "$binPath\BruteGamingMacros.exe" -Destination $tempDir
          Copy-Item "$binPath\BruteGamingMacros.exe.config" -Destination $tempDir -ErrorAction SilentlyContinue

          # Create README
          $readme = @"
Brute Gaming Macros v$version$suffix - Portable Edition

INSTALLATION:
1. Extract all files to a folder of your choice
2. Run BruteGamingMacros.exe as Administrator
3. Configure your game profiles and hotkeys

REQUIREMENTS:
- Windows 10/11 (64-bit)
- .NET Framework 4.8.1
- Administrator privileges

CONFIGURATION:
Server Mode: $config

ANTIVIRUS WARNING:
This application may trigger false positives. Please whitelist the application folder.

Documentation: https://github.com/epicseo/BruteGamingMacros/blob/main/docs/ANTIVIRUS.md
Support: https://github.com/epicseo/BruteGamingMacros/issues

LICENSE: MIT License
"@
          Set-Content -Path "$tempDir\README.txt" -Value $readme

          # Create ZIP
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipName -Force
          Remove-Item $tempDir -Recurse -Force

          Write-Host "Created: $zipName"
        }

        # Create portable packages for each configuration
        Create-PortablePackage "Release" ""
        Create-PortablePackage "ReleaseMR" "-MR"
        Create-PortablePackage "ReleaseHR" "-HR"
        Create-PortablePackage "ReleaseLR" "-LR"

    - name: Generate SHA256 checksums
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $output = @()

        $output += "Brute Gaming Macros v$version - SHA256 Checksums"
        $output += "Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
        $output += ""

        # Checksum for executables
        Get-ChildItem "bin\Release*\BruteGamingMacros.exe" | ForEach-Object {
          $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
          $output += "$($_.Directory.Name)\$($_.Name)"
          $output += "  $hash"
          $output += ""
        }

        # Checksum for portable ZIPs
        Get-ChildItem "*.zip" | ForEach-Object {
          $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
          $output += $_.Name
          $output += "  $hash"
          $output += ""
        }

        # Checksum for installer (if exists)
        $installerPath = "installer\BruteGamingMacros-Setup-v$version.exe"
        if (Test-Path $installerPath) {
          $hash = (Get-FileHash $installerPath -Algorithm SHA256).Hash
          $output += "BruteGamingMacros-Setup-v$version.exe"
          $output += "  $hash"
          $output += ""
        }

        Set-Content -Path "checksums.txt" -Value $output
        Get-Content checksums.txt

    - name: Extract changelog for this version
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        if (Test-Path "docs\CHANGELOG.md") {
          $changelog = Get-Content "docs\CHANGELOG.md" -Raw
          $pattern = "## \[$version\].*?(?=## \[|\z)"
          $match = [regex]::Match($changelog, $pattern, [System.Text.RegularExpressions.RegexOptions]::Singleline)

          if ($match.Success) {
            $notes = $match.Value
          } else {
            $notes = "Release v$version`n`nSee CHANGELOG.md for details."
          }

          Set-Content -Path "release-notes.md" -Value $notes
          Write-Host "Release notes:"
          Get-Content "release-notes.md"
        } else {
          Set-Content -Path "release-notes.md" -Value "Release v$version"
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BruteGamingMacros-v${{ steps.version.outputs.VERSION }}
        path: |
          *.zip
          checksums.txt
          installer/*.exe
          release-notes.md

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          *.zip
          checksums.txt
          installer/*.exe
        body_path: release-notes.md
        draft: false
        prerelease: false
        fail_on_unmatched_files: false

    - name: Build summary
      shell: powershell
      run: |
        Write-Host "======================================" -ForegroundColor Cyan
        Write-Host "Build Summary" -ForegroundColor Cyan
        Write-Host "======================================" -ForegroundColor Cyan
        Write-Host "Version: ${{ steps.version.outputs.VERSION }}" -ForegroundColor Green
        Write-Host ""
        Write-Host "Artifacts created:" -ForegroundColor Yellow
        Get-ChildItem "*.zip" | ForEach-Object {
          Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)" -ForegroundColor White
        }
        if (Test-Path "installer\*.exe") {
          Get-ChildItem "installer\*.exe" | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)" -ForegroundColor White
          }
        }
        Write-Host ""
        Write-Host "✓ BUILD COMPLETED SUCCESSFULLY!" -ForegroundColor Green
